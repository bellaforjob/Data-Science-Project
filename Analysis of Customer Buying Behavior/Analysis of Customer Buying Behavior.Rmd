---
title: "Analysis of Customer Buying Behavior"
author: "Bei Wang"
date: "06/19/2021"
output:
  html_document:
    df_print: paged
    output: null
    toc: yes
    toc_float: yes
    theme: united
  df_print: paged
  code_folding: hide
  editor_options:
    chunk_output_type: inline
  chunk_output_type: console
  pdf_document:
    toc: yes
params: Customer_Behaviour.csv
---
# Data Set Overview
The data set was created from information collected from a Kaggle survey to do the survey of customer's behavior. The data represents details about 400 clients of a company including the unique ID, the gender, the age of the customer and the salary.(Data set source: https://www.kaggle.com/denisadutca/customer-behaviour)
 
# Goal of Analysis
Due to the limited customer background provided by the data, this analysis will focus on the customers who have purchased behavior. The purpose of analysis is to collect information about purchasing decisions and analyze the relationship between these factors. In this way, we can know what factors affect people's purchasing decisions? Age, salary or gender?

# Data Preparation
The data analysis of this project is only based on the people who have purchased. So I subset the data set by selecting "purchase=1".
I did a few things of preparation:
1. Check if null data in the dataset: there is no null data in the dataset.
2. Rename of column: rename "EstimatedSalary" to "Salary". 
3. Create the subset of purchased.
4. Separate Data set into the age groups: age 18~24, age 25~34, age 35~44, age 45~54, age 55~60 by breaks and counts in hist.

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(UsingR)
library(rmarkdown)
library(dashCoreComponents)
library(sampling)
library(prob)

# load data
dow <- read.csv("/Users/beiwang/Documents/0. BU MS/CS544/1. CS544 Final Project/CSS544Final_Wang/Customer_Behaviour.csv")
head(dow)
names(dow)
nrow(dow)
ncol(dow)
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
### data preparing and checking ####
is.null(dow)
names(dow)[names(dow)=="EstimatedSalary"] <- "Salary"

data_purchased  <- subset(dow, dow$Purchased == 1)
data_purchased

dow_age <- data_purchased[order(data_purchased$Age),]
dow_age
```
# Analyze Buyers

## Summary 
```{r echo=FALSE, message=FALSE, warning=FALSE}
options(digit = 2)

sum_da <- data.frame(
  Age = as.vector(summary(dow_age$Age),),
  Salary = as.vector(summary(dow_age$Salary))
)
rownames(sum_da) <- c("Min", "Q1", "Q2", "Mean", "Q3", "Max")
sum_da
```
## Age of Buyers
First look at the age distribution of buyers. The age of buyers is concentrated between 25 and 54 years old. the age range from 35 to 45 years old accounted for 45%; followed by 25 to 34 years old, accounting for about 24%; 45 to 54 accounted for about 20%, the overall distribution plot is slightly skewed right. From a set of data, it can be basically considered that the age from 25 to 54 is the buying group, and the 45 to 54 is the main buying group.

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
a <- hist(dow_age$Age, breaks=c(18, 24, 34, 44, 54, 60), col = "blue", 
          ylim= c(0, 0.06),xlim = c(18, 60)) 
a$breaks
a$counts

breaks.labels <- c("Ages 18~24", "Ages 25~34", "Ages 35~44", "Ages 45~54","Ages 55~60", "Ages above 61")
breaks <- a$breaks
counts <- c(a$counts,0)
# percentage of each age group
options(digit=2)
for(i in 1:length(a$counts)){
  cat(a$counts[i] / nrow(dow_age), " ")
}
```

```{r echo=FALSE,message=FALSE}
library(plotly)
fig <- plot_ly(y= counts, x = breaks, type = "bar", name= breaks.labels,color= rainbow(6))
fig <- fig %>% layout(title = "Age of buyers")

fig
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
## subplots of ages
age.1 <- dow_age$Age[dow_age$Age %in% c(18:24)]
age.2 <- dow_age$Age[dow_age$Age %in% c(25:34)]
age.3 <- dow_age$Age[dow_age$Age %in% c(35:44)]
age.4 <- dow_age$Age[dow_age$Age %in% c(45:54)]
age.5 <- dow_age$Age[dow_age$Age %in% c(55:60)]
```

```{r echo=FALSE, warning=FALSE,message=FALSE}
#plot of ages
library(plotly)
fig2 <- plot_ly(x = age.2, type = "histogram", name="Age = 25~34")
fig3 <- plot_ly(x = age.3, type = "histogram", name="Age = 35~44")
fig4 <- plot_ly(x = age.4, type = "histogram", name="Age = 45~54")
fig5 <- plot_ly(x = age.5, type = "histogram", name="Age = 55~60")
fig <-  subplot(fig2, fig3, fig4, fig5, nrows = 2)
fig <- fig %>% layout(title = "Age of buyers by age groups")
fig
```
## Salary of Buyers
In addition to the age factor, is the income of each age group also one of the factors affecting purchasing power?
It can be seen from the plot that people aged from 25 to 34 for the highest income, and the income range is small, with the middle position reaching 121.5k. The second is 35 to 44 year, the income in this range is a bit larger, but the middle position has reached 108k. The income range of 45 to 54 has obviously widened, but at the same time the highest value has also fallen, even lower than the median of the previous age group. When the age is greater than 55, the overall income range increases and the range expands.A interesting thing is: from the last plot, we know the age range 45 to 54 is the main buying group, but the salary's range is lowest than other group. so,in this project, the high salary is not the key factor to affect the buying power.
```{r include=FALSE,message=FALSE}
########## Salary by age ##################
salary.1 <- dow_age$Salary[dow_age$Age %in% c(18:24)]
salary.1
salary.2 <- dow_age$Salary[dow_age$Age %in% c(25:34)]
salary.2
salary.3 <- dow_age$Salary[dow_age$Age %in% c(35:44)]
salary.3
salary.4 <- dow_age$Salary[dow_age$Age %in% c(45:54)]
salary.4
salary.5 <- dow_age$Salary[dow_age$Age %in% c(55:60)]
salary.5
```
```{r echo=FALSE, warning=FALSE,message=FALSE}
library(plotly)
fig <- plot_ly(y = salary.1, type = "box", quartilemethod="linear", name="Age = 18~24")
fig <- fig %>% add_trace(y = salary.2, quartilemethod="inclusive", name="Age = 25~34")
fig <- fig %>% add_trace(y = salary.3, quartilemethod="inclusive", name="Age = 35~44")
fig <- fig %>% add_trace(y = salary.4, quartilemethod="inclusive", name="Age = 45~54")
fig <- fig %>% add_trace(y = salary.5, quartilemethod="inclusive", name="Age = 55~60")
fig <- fig %>% layout(title = "Salary of buyers by age")

fig
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
cat("The IQR of salary in each age group:", "\n", "\n",
    "Age 25~34 IQR:", fivenum(salary.2)[4]-fivenum(salary.2)[2], "\n",
  "Age 35~44 IQR:", fivenum(salary.3)[4]-fivenum(salary.3)[2], "\n",
  "Age 45~54 IQR:", fivenum(salary.4)[4]-fivenum(salary.4)[2], "\n",
  "Age 55~60 IQR:", fivenum(salary.5)[4]-fivenum(salary.5)[2])
```


```{r echo=FALSE, warning=FALSE,message=FALSE}
library(plotly)
fig <- plot_ly(x = salary.1, type = "histogram", name="Age = 18~24")
fig <- fig %>% add_trace(x = salary.2, name="Age = 25~34")
fig <- fig %>% add_trace(x = salary.3, name="Age = 35~44")
fig <- fig %>% add_trace(x = salary.4, name="Age = 45~54")
fig <- fig %>% add_trace(x = salary.5, name="Age = 55~60")
fig <- fig %>% layout(title = "Salaries of buyer by age")

fig
```
## Gender of Buyers
People usually think that women love shopping more than men. Is this true?
In the plot below, we will find there are not bigger different of female and male buyers between the age below 25 and order than 55. But in age 45 to 54, female buyer obviously more than male; but in age 35 to 44, the male buyer will shop more times than female. 
```{r message=FALSE, include=FALSE}
####### genders of buyer #########3
genders.2 <- dow_age$Gender[dow_age$Age %in% c(25:34)]
genders.2f <- genders.2[genders.2 == "Female"]
genders.2m <- genders.2[genders.2 == "Male"]
genders.2f
genders.2m
genders.3 <- dow_age$Gender[dow_age$Age %in% c(35:44)]
genders.3f <- genders.3[genders.3 == "Female"]
genders.3m <- genders.3[genders.3 == "Male"]
genders.3f
genders.3m

genders.4 <- dow_age$Gender[dow_age$Age %in% c(45:54)]
genders.4f <- genders.4[genders.4 == "Female"]
genders.4m <- genders.4[genders.4 == "Male"]
genders.4f
genders.4m

genders.5 <- dow_age$Gender[dow_age$Age %in% c(55:60)]
genders.5f <- genders.5[genders.5 == "Female"]
genders.5m <- genders.5[genders.5 == "Male"]
genders.5f
genders.5m

```

```{r echo=FALSE, warning=FALSE,message=FALSE}
library(plotly)
# plot of genders of buyer
g <- c("Female", "Male")
g_2 <- c(length(genders.2f), length(genders.2m))
g_3 <- c(length(genders.3f), length(genders.3m))
g_4 <- c(length(genders.4f), length(genders.4m))
g_5 <- c(length(genders.5f), length(genders.5m))
data <- data.frame(g, g_2, g_3, g_4, g_5)

fig <- plot_ly(data, x = g, y = g_2, type = 'bar', name = 'Age=25~34')
fig <- fig %>% add_trace(y = g_3, name = 'Age=35~44')
fig <- fig %>% add_trace(y = g_4, name = 'Age=45~54')
fig <- fig %>% add_trace(y = g_5, name = 'Age=55~60')
fig <- fig %>% layout(title = "Gender of buyers by age", yaxis = list(title = 'Count'), barmode = 'stack')

fig
```

Among all buyers, female accounted for 53%, and male accounted for 46%. Female buyers are more than male.

# Central Limit Theorem
"The Central Limit Theorem states that the distribution of the sample means for a given sample size of the population has the shape of the normal distribution. The theorem is shown with various distributions of the input data in the following sections.‚Äù Along with the sample size gets larger, the means of the samples become a normal distribution. Use the central limit theorem to show the age variable of the data set. As shown in the bar plot and histogram above, the age distributions of all groups are skewed to the right. I will use this as an example to illustrate the application of the central limit theorem. The histogram below shows the sample means of 1000 random samples with sample sizes of 10, 20, 30, and 40, which follow a normal distribution.
```{r include=FALSE,message=FALSE}
set.seed(123)
samples<- 1000
x <- dow_age$Age
xbar <- numeric(samples)
```

```{r echo=FALSE,message=FALSE}
cat("The Ages means:", mean(dow_age$Age), " SD is:", sd(dow_age$Age),"\n\n")

for (size in c(10, 20, 30, 40)) {
  for (i in 1:samples) {
    xbar[i] <- mean(sample(x, size = size, replace = FALSE))
  }
  cat("Sample Size = ", size, " Mean = ", mean(xbar),
      " SD = ", sd(xbar), "\n")
}
```

```{r include=FALSE,message=FALSE}
xbar1 <- numeric(samples)
for(i in 1:samples){
  xbar1[i] <- mean(sample(x, 10, replace = FALSE))
}
xbar2 <- numeric(samples)
for(i in 1:samples){
  xbar2[i] <- mean(sample(x, 20, replace = FALSE))
}

xbar3 <- numeric(samples)
for(i in 1:samples){
  xbar3[i] <- mean(sample(x, 30, replace = FALSE))
}

xbar4 <- numeric(samples)
for(i in 1:samples){
  xbar4[i] <- mean(sample(x, 10, replace = FALSE))
}
```

```{r echo=FALSE, warning=FALSE,message=FALSE}
library(plotly)
fig1 <- plot_ly(x = xbar1, colors = "red",type = "histogram",histnorm = "probability", name = "n=10")

fig2 <- plot_ly(x = xbar2, colors = "blue",type = "histogram",histnorm = "probability", name = "n=20")

fig3 <- plot_ly(x = xbar3, colors = "yellow",type = "histogram",histnorm = "probability", name ="n=30")

fig4 <- plot_ly(x = xbar4, colors = "green",type = "histogram",histnorm = "probability", name="n=40")

fig <- subplot(fig1, fig2, fig3, fig4, nrows = 2)
fig
```
# Sampling
"A sample is a portion of the population that is selected for doing the data analysis. The results from this sample are then used to estimate the characteristics of the population."Sampling will greatly help us save working time, reduce workload, and reduce the difficulty of analysis. There are many different type of sampling.I randomly select 20 samples from customers who have purchased by age, and do analysis with perform simple random sample, Sample Random Sampling Without replacement, and Systematic sampling. Based on the size of each age, I only strata one sample from the each layer to do stratified sampling analysis.

```{r message=FALSE, warning=FALSE, include=FALSE}
##### sample random sampling
set.seed(123)
n <- 20

## 
N <- nrow(dow_age)
e <- numeric(N)
for (i in 1: N) {
  e[i] <- mean(sample(dow_age$Age, n, replace = FALSE))
}

#plot of random sample
f2 <- plot_ly(x = e, name= "All Ages",
             type = "histogram",
             histnorm = "probability")

#####Sample Random Sampling Without replacement
s <- srswor(n, N)

sample.s <- dow_age[s != 0,]
sample.s

#plot of srswor
fs <- plot_ly(x = sample.s$Age, name= "SRSWOR",
             type = "histogram",
             histnorm = "probability")

#####Systematic sampling
k <- ceiling(N/n)

r <- sample(k, 1)   #select a random item from first group

ss <- seq(r, by =k, length = n) 
sample.ss <- dow_age[ss,]

#plot of systematic sampling
fss <- plot_ly(x = sample.ss$Age, name= "Systematic Sampling",
             type = "histogram",
             histnorm = "probability")

#####Systematic sampling unequal Probability
pik <- inclusionprobabilities(dow_age$Age, n)

sss <- UPsystematic(pik)

sample.sss <- dow_age[sss != 0,]
getdata(dow_age, sample.sss)

#stratified sampling
#strata one sample from each age
order.index <- order(dow_age$Age)

data <- dow_age[order.index, ]
freq <- table(data$Age) 
freq
size <- round(n * freq / sum(freq))
size

sts <- strata(data, stratanames = c("Age"),size = rep(1,34), method = "srswor")
sample.sts <- getdata(data, sts)
options(digit = 2)
sample.sts
#plot of systematic sampling unequal Probability
fsts <- plot_ly(x = sample.sts$Age, name= "Stratified Sampling",
             type = "histogram",
             histnorm = "probability")
fsts

```

```{r echo=FALSE, warning=FALSE,message=FALSE}
library(plotly)
#plot of systematic sampling unequal Probability
fsss <- plot_ly(x = sample.sss$Age, name= "Systematic Sampling UP",
             type = "histogram",
             histnorm = "probability")

fig_s <-subplot(f2, fs, fss, fsss, fsts, nrows = 5, shareX = TRUE)
fig_s
```
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
options(digit = 2)
cat(" The mean of Age:", mean(dow_age$Age), "\n",
    "The mean of sample random sampling of Age:", mean(e), "\n",
    "The mean of sample random sampling without Replace of Age:", mean(sample.s$Age), "\n",
"The mean of systematic sampling of Age:", mean(sample.ss$Age[!is.na(sample.ss$Age)]), "\n",
"The mean of systematic sampling unequal probability of Age:", mean(sample.sss$Age),"\n",
"The mean of stratified sampling of Age:", mean(sample.sts$Age))
```
The means of sample using simple random sampling without replacement and systematic sampling are similar with the mean of data; 
The mean of unequal probabilities sample random sampling without Replace and systematic based on inclusion probabilities using the age variable is bigger then mean of data; 
Stratified sampling is less than the mean of data. It may be caused by the limited size of each age in age variable.

# Relationship Between Variables
Going back to the original question, compare the age, gender, and income provided by customers who have made purchases to see what kind of relationship they have.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
axis = list(showline=FALSE,
            zeroline=FALSE,
            gridcolor='#ffff',
            ticklen=4)

fig <- plot_ly() 
fig <- fig %>%
  add_trace(
    type = 'splom',
    dimensions = list(
      list(label='Ages', values=~dow_age$Age),
      list(label='Salary', values=~dow_age$Salary),
      list(label='Gender', values=~factor(dow_age$Gender))
    ),
    text=~class,
    marker = list(
      size = 3,
      line = list(
        width = 1
      )
    )
  ) 
fig <- fig %>%
  layout(
    title= 'Relattionship of factors',
    hovermode='closest',
    dragmode= 'select',
    plot_bgcolor='rgba(240,240,240, 0.95)',
    xaxis=list(domain=NULL, showline=F, zeroline=F, gridcolor='#ffff', ticklen=4),
    yaxis=list(domain=NULL, showline=F, zeroline=F, gridcolor='#ffff', ticklen=4),
    xaxis2=axis,
    xaxis3=axis,
    yaxis2=axis,
    yaxis3=axis
  )

fig
```
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
cat("The correlation coefficient between Age and Salary is:", cor(dow_age$Age, dow_age$Salary))
```
It can be seen from the plot that the sharp between age and salary is related, but it is not much related to gender.  After calculation the correlation of age and salary, result is -0.369,  the relationship can be considered that age and income have a negative relationship. 



# Conclusion
In summary, among all buyers, middle-aged and elderly people with lower incomes are more keen on shopping; gender factors make a little difference in shopping behavior.
Therefore, foucus on middle-aged and elderly people, sell products corresponding to the lower and higher income categories, take into account both female and male products. That will be a huge market.


# Reference
1. Module 3 & 5 PDF of CSS544
2. Plotly R Graphing Libraries: https://plotly.com/r/
3. Data set source: https://www.kaggle.com/denisadutca/customer-behaviour

